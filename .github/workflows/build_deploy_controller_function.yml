
name: Build and deploy Controller Function
run-name: Build and deploy Controller Function
on:
  push:
    paths:
      - github-runner-controller-function/**
  workflow_dispatch:

permissions:
  id-token: write 
  contents: read 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
    - name: 'Checkout Repository'
      uses: actions/checkout@v4

    - name: 'Login via Azure CLI'
      uses: azure/login@v2
      with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: 'Prepare and Deploy Function'
      run: |
        cd github-runner-controller-function
        
        # Clean up development files
        rm -rf .venv .vscode __pycache__ .pytest_cache
        find . -name "*.pyc" -delete
        find . -name ".git*" -delete
        
        # Show what we're deploying
        echo "=== Files being deployed ==="
        ls -la
        
        # Create zip package
        zip -r ../controller-function.zip .
        cd ..
        
        # Deploy using Azure CLI
        echo "=== Starting deployment ==="
        az functionapp deployment source config-zip \
          --resource-group "awesomeproj-dev-rg" \
          --name "awesomeproj-dev-controller-function-app" \
          --src controller-function.zip \
          --timeout 600
          
     